#!/usr/bin/env ruby
$:.unshift File.expand_path(File.dirname(__FILE__) + "/../lib")

require 'rubygems'
require 'optparse'
require 'logger'
require 'kepler_processor'

LOGGER = Logger.new STDOUT
LOGGER.level = Logger::INFO

options = { :command => KeplerProcessor::Convertor, :input_paths => [], :output_path => "data/output", :file_columns => [0,1], :column_delimiter => " " }

option_parser = OptionParser.new do |opts|
  opts.banner = "Usage: kepler -c command [-o output_directory] [--columns 0,1] [-d ,] path_to_input_file(s)"

  opts.on("-c", "--command COMMAND", String, "Specify the command to run [convert/transform/merge/append/plot_lc/uniquify/catalogue]") do |c|
    options[:command] = { "convert" => KeplerProcessor::Convertor, "transform" => KeplerProcessor::Transformer, "merge" => KeplerProcessor::Merger, "plot_lc" => KeplerProcessor::LightCurvePlotter, "uniquify" => KeplerProcessor::IndexDupRemover, "catalogue" => KeplerProcessor::CatalogueMaker, "append" => KeplerProcessor::Appender }[c]
    if options[:command].nil?
      LOGGER.error "Invalid command. Options are [convert/transform/merge/append/plot_lc/uniquify/catalogue]"
      puts opts
      exit
    end
  end
  opts.on("-f", "--[no-]force_overwrite", "Force overwrite existing output files") do |f|
    options[:force_overwrite] = f
  end
  opts.on("-C", "--columns 0,1", Array, "Choose input file columns to be read. Defaults to 0,1") do |f|
    options[:file_columns] = f.map(&:to_i)
  end
  opts.on("-d", "--delimiter DELIMITER", String, "Specify delimiting character. Defaults to a single space") do |f|
    options[:column_delimiter] = f
  end
  opts.on("-o", "--output PATH", String, "Specify the path to the output directory. Defaults to data/output") do |p|
    options[:output_path] = p
  end
  opts.on("-m", "--merge-ratio RATIO", Integer, "Specify a merge ratio to use.") do |p|
    options[:merge_ratio] = p
  end
  opts.on_tail("-h", "--help", "Show this message") do
    puts opts
    exit
  end
  opts.on_tail("-v", "--version", "Show version") do
    puts KeplerProcessor::VERSION
    exit
  end
end

if ARGV.size.zero?
  option_parser.parse '--help'
else
  begin
    options[:input_paths] = option_parser.parse! # returns anything not handled by the options above - the input filenames.
  rescue
    LOGGER.error $! # print out error
    option_parser.parse '--help' # print out command glossary
  end
end

if options[:command] == KeplerProcessor::Merger && !options.has_key?(:merge_ratio)
  LOGGER.error "You must provide an integer merge ratio"
  option_parser.parse '--help'
  exit
end

puts options.inspect

options[:input_paths].each do |filename|
  begin
    c = options[:command].new filename, options
    c.run
  rescue KeplerProcessor::FileExistsError
    LOGGER.info "Your output file (#{c.full_output_filename}) already exists, please remove it first (or something)."
  rescue => e
    LOGGER.error e.exception
  ensure
    c = nil
  end
end

LOGGER.close
